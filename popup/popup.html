<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nostr WoT Settings</title>
    <link rel="stylesheet" href="popup.css">
</head>
<body>
<div class="header">
    <div class="logo">
        <svg width="26" height="26" viewBox="0 0 48 48" fill="none">
            <!-- Connection lines -->
            <g stroke="rgba(255,255,255,0.5)" stroke-width="1.5">
                <line x1="24" y1="24" x2="24" y2="12"/>
                <line x1="24" y1="24" x2="34" y2="17"/>
                <line x1="24" y1="24" x2="36" y2="27"/>
                <line x1="24" y1="24" x2="30" y2="35"/>
                <line x1="24" y1="24" x2="17" y2="34"/>
                <line x1="24" y1="24" x2="12" y2="22"/>
                <line x1="24" y1="12" x2="18" y2="6"/>
                <line x1="24" y1="12" x2="30" y2="6"/>
                <line x1="34" y1="17" x2="42" y2="12"/>
                <line x1="36" y1="27" x2="43" y2="30"/>
                <line x1="30" y1="35" x2="35" y2="42"/>
                <line x1="17" y1="34" x2="12" y2="42"/>
                <line x1="12" y1="22" x2="5" y2="18"/>
            </g>
            <!-- Outer nodes -->
            <g fill="rgba(255,255,255,0.6)">
                <circle cx="18" cy="6" r="2.5"/>
                <circle cx="30" cy="6" r="2.5"/>
                <circle cx="42" cy="12" r="2.5"/>
                <circle cx="43" cy="30" r="2.5"/>
                <circle cx="35" cy="42" r="2.5"/>
                <circle cx="12" cy="42" r="2.5"/>
                <circle cx="5" cy="18" r="2.5"/>
            </g>
            <!-- First ring nodes -->
            <g fill="rgba(255,255,255,0.9)">
                <circle cx="24" cy="12" r="3.5"/>
                <circle cx="34" cy="17" r="3.5"/>
                <circle cx="36" cy="27" r="3.5"/>
                <circle cx="30" cy="35" r="3.5"/>
                <circle cx="17" cy="34" r="3.5"/>
                <circle cx="12" cy="22" r="3.5"/>
            </g>
            <!-- Center node -->
            <circle cx="24" cy="24" r="5" fill="white"/>
        </svg>
    </div>
    <div class="title">
        <h1>Nostr WOT</h1>
        <span class="subtitle">Web of Trust</span>
    </div>
    <div class="menu-container">
        <button id="menuBtn" class="menu-btn" title="Settings">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
        </button>
        <div id="menuDropdown" class="menu-dropdown hidden">
            <button class="menu-item" data-modal="scoringModal">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20V10"/>
                    <path d="M18 20V4"/>
                    <path d="M6 20v-4"/>
                </svg>
                Scoring & Weights
            </button>
            <button class="menu-item" data-modal="advancedModal">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6"/>
                    <path d="M1 12h6m6 0h6"/>
                </svg>
                Advanced Options
            </button>
        </div>
    </div>
</div>

<div class="card">
    <label for="myPubkey">Your Pubkey</label>
    <input id="myPubkey" placeholder="npub or hex (64 characters)" class="mono">
    <span class="hint">Your Nostr public key in hex format</span>
</div>

<div id="permissionCard" class="card permission-card hidden">
    <div id="permissionNeeded" class="permission-section">
        <label>Permission Required</label>
        <span class="hint">Choose how you want to use the extension</span>
        <div class="permission-buttons">
            <button id="enableActiveTab" class="btn btn-primary btn-small">Enable for this tab</button>
            <button id="enableAllSites" class="btn btn-secondary btn-small">Enable for all sites</button>
        </div>
    </div>
    <div id="permissionActiveTab" class="permission-section hidden">
        <div class="permission-granted">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
            </svg>
            <span>Enabled for current tab</span>
        </div>
        <button id="upgradeToAllSites" class="btn btn-secondary btn-small">Enable for all sites</button>
    </div>
    <div id="permissionAllSites" class="permission-section hidden">
        <div class="permission-granted">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
            </svg>
            <span>Auto-inject enabled for all sites</span>
        </div>
    </div>
</div>

<div class="card">
    <label>Mode</label>
    <div class="mode-selector">
        <input type="radio" name="mode" id="mode-remote" value="remote">
        <label for="mode-remote" class="mode-option">
            <span class="mode-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
                </svg>
            </span>
            <span class="mode-label">Remote</span>
            <span class="mode-desc">Query oracle API</span>
        </label>

        <input type="radio" name="mode" id="mode-local" value="local">
        <label for="mode-local" class="mode-option">
            <span class="mode-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="5" rx="9" ry="3"/>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                </svg>
            </span>
            <span class="mode-label">Local</span>
            <span class="mode-desc">Use indexed graph</span>
        </label>

        <input type="radio" name="mode" id="mode-hybrid" value="hybrid">
        <label for="mode-hybrid" class="mode-option">
            <span class="mode-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
            </span>
            <span class="mode-label">Hybrid</span>
            <span class="mode-desc">Local + fallback</span>
        </label>
    </div>
</div>

<div id="localSection" class="card">
    <label>Local Graph</label>
    <div id="stats" class="stats-box">
        <div class="stats-row">
            <span class="stats-label">Status</span>
            <span class="stats-value" id="statsStatus">Not synced</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">Total Nodes</span>
            <span class="stats-value" id="statsNodes">-</span>
        </div>
        <div id="depthStats" class="depth-stats hidden"></div>
        <div class="stats-row">
            <span class="stats-label">Edges</span>
            <span class="stats-value" id="statsEdges">-</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">Storage</span>
            <span class="stats-value" id="statsSize">-</span>
        </div>
    </div>

    <div class="sync-controls">
        <div class="depth-selector">
            <label for="syncDepth">Sync depth</label>
            <select id="syncDepth">
                <option value="1">1 hop (fast)</option>
                <option value="2" selected>2 hops (recommended)</option>
                <option value="3">3 hops (slow)</option>
            </select>
        </div>
        <button id="sync" class="btn btn-primary">
            <svg class="btn-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M23 4v6h-6M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            Sync Graph
        </button>
    </div>

    <button id="clear" class="btn btn-danger btn-small">Clear Local Data</button>

    <div id="syncStatus" class="sync-status hidden">
        <div class="sync-status-content">
            <div class="sync-status-text">
                <span class="sync-spinner"></span>
                <span id="syncStatusText">Syncing...</span>
            </div>
            <button id="stopSync" class="btn btn-danger btn-small">Stop</button>
        </div>
        <div id="syncProgress" class="sync-progress"></div>
    </div>
</div>

<div class="card">
    <label for="testTarget">Test Distance</label>
    <div class="test-section">
        <input id="testTarget" placeholder="Target pubkey (hex)" class="mono">
        <button id="test" class="btn btn-secondary">Check</button>
    </div>
    <div id="testResult" class="test-result"></div>
</div>

<div class="actions">
    <button id="save" class="btn btn-primary btn-large">Save Settings</button>
</div>

<!-- Scoring Modal -->
<div id="scoringModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Scoring & Weights</h2>
            <button class="modal-close" data-modal="scoringModal">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="scoring-info">
                <span class="hint">score = base + pathBonus (capped)</span>
            </div>

            <label>Base Score (%)</label>
            <span class="hint">Base score per hop distance (1 hop = 100%)</span>
            <div class="weight-grid weight-grid-3">
                <div class="weight-item">
                    <label for="weight2">2 hops</label>
                    <input type="number" id="weight2" min="0" max="100" step="5" value="50">
                </div>
                <div class="weight-item">
                    <label for="weight3">3 hops</label>
                    <input type="number" id="weight3" min="0" max="100" step="5" value="25">
                </div>
                <div class="weight-item">
                    <label for="weight4">4+ hops</label>
                    <input type="number" id="weight4" min="0" max="100" step="5" value="10">
                </div>
            </div>

            <label>Path Bonus % (per hop level)</label>
            <span class="hint">Bonus per additional shortest path to target</span>
            <div class="weight-grid weight-grid-3">
                <div class="weight-item">
                    <label for="pathBonus2">2 hops</label>
                    <input type="number" id="pathBonus2" min="0" max="100" step="1" value="15">
                </div>
                <div class="weight-item">
                    <label for="pathBonus3">3 hops</label>
                    <input type="number" id="pathBonus3" min="0" max="100" step="1" value="10">
                </div>
                <div class="weight-item">
                    <label for="pathBonus4">4+ hops</label>
                    <input type="number" id="pathBonus4" min="0" max="100" step="1" value="5">
                </div>
            </div>

            <label for="maxPathBonus">Max Path Bonus (%)</label>
            <input type="number" id="maxPathBonus" min="0" max="200" step="5" value="50">
            <span class="hint">Cap on total path bonus (e.g., 50 = +50% max)</span>
        </div>
        <div class="modal-footer">
            <button id="resetScoring" class="btn btn-secondary btn-small">Reset to Defaults</button>
            <button class="btn btn-primary modal-save" data-modal="scoringModal">Save</button>
        </div>
    </div>
</div>

<!-- Advanced Options Modal -->
<div id="advancedModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Advanced Options</h2>
            <button class="modal-close" data-modal="advancedModal">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <label for="oracleUrl">Oracle URL</label>
            <input id="oracleUrl" placeholder="https://wot-oracle.mappingbitcoin.com" class="mono">
            <span class="hint">WOT Oracle API endpoint for remote queries</span>

            <label for="relays">Relays</label>
            <textarea id="relays" placeholder="wss://relay.damus.io&#10;wss://nos.lol&#10;wss://relay.nostr.band&#10;wss://relay.mappingbitcoin.com" class="mono"></textarea>
            <span class="hint">Nostr relays for fetching contact lists (one per line or comma-separated)</span>

            <label for="maxHops">Max Hops</label>
            <input type="number" id="maxHops" min="1" max="6" value="3">
            <span class="hint">Maximum search depth for trust queries (default: 3)</span>

            <label for="timeout">Timeout (ms)</label>
            <input type="number" id="timeout" min="1000" max="30000" step="1000" value="5000">
            <span class="hint">Request timeout in milliseconds (default: 5000)</span>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary modal-save" data-modal="advancedModal">Save</button>
        </div>
    </div>
</div>

<div id="status" class="status"></div>

<script type="module" src="popup.js"></script>
</body>
</html>
